<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BGTK SULTENG - {{ dashboard_title|default('Dashboard Admin') }}</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='TUT.png') }}">
    <link rel="shortcut icon" type="image/png" href="{{ url_for('static', filename='TUT.png') }}">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='TUT.png') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        .dashboard-hero {
            background: linear-gradient(135deg, rgba(6, 122, 193, 0.95) 0%, rgba(4, 90, 150, 0.95) 100%);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 15px 45px 30px 45px;
            color: white;
            margin-bottom: 35px;
            box-shadow:
                0 15px 50px rgba(6, 122, 193, 0.4),
                0 0 0 1px rgba(255, 255, 255, 0.2) inset,
                0 25px 70px rgba(4, 90, 150, 0.3);
            position: relative;
            overflow: visible;
            border: 1px solid rgba(255, 255, 255, 0.25);
        }

        .dashboard-hero h1 {
            font-size: 38px;
            font-weight: 700;
            margin-bottom: 8px;
            color: white;
            margin-top: 0;
        }

        .dashboard-hero p {
            font-size: 18px;
            opacity: 0.95;
            margin: 0;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 24px;
            margin-bottom: 35px;
        }

        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 28px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            border: 1px solid rgba(6, 122, 193, 0.1);
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 30px rgba(6, 122, 193, 0.15);
        }

        /* Klik-able stat cards (link wrapper) */
        .stat-card-link {
            display: block;
            text-decoration: none;
            color: inherit;
            border-radius: 16px;
        }

        .stat-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .stat-card-icon {
            font-size: 36px;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            background: linear-gradient(135deg, #067ac1 0%, #045a96 100%);
        }

        .stat-card-icon .sidebar-icon svg {
            width: 30px;
            height: 30px;
        }

        .stat-card-title {
            font-size: 14px;
            color: #6b7280;
            font-weight: 500;
            margin: 0;
        }

        .stat-card-value {
            font-size: 32px;
            font-weight: 700;
            color: #067ac1;
            margin: 8px 0 0 0;
        }

        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 35px;
        }

        .action-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            border: 1px solid rgba(6, 122, 193, 0.1);
            text-decoration: none;
            color: inherit;
            display: block;
        }

        .action-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 30px rgba(6, 122, 193, 0.15);
        }

        .action-card-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .action-card-title {
            font-size: 16px;
            font-weight: 600;
            color: #067ac1;
            margin: 0;
        }

        .action-card-desc {
            font-size: 13px;
            color: #6b7280;
            margin-top: 6px;
        }

        .flash-messages {
            margin-bottom: 25px;
        }

        .flash-message {
            padding: 14px 18px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 12px;
        }

        .flash-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #6ee7b7;
        }

        .flash-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        .flash-warning {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fcd34d;
        }

        .flash-info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }

        @media (max-width: 768px) {
            .dashboard-hero h1 {
                font-size: 28px;
            }

            .dashboard-hero p {
                font-size: 16px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .quick-actions {
                grid-template-columns: 1fr;
            }
        }

        .kabupaten-popup-grid {
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 20px;
            justify-content: center;
            max-width: 100%;
            overflow-x: auto;
        }
        .kabupaten-popup-item {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 2px solid #067ac1;
            border-radius: 12px;
            padding: 16px 20px;
            text-align: center;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            min-width: 140px;
            flex: 0 0 auto;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .kabupaten-popup-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(6, 122, 193, 0.3);
            border-color: #045a96;
        }
        .kabupaten-popup-name {
            font-size: 13px;
            font-weight: 600;
            color: #067ac1;
            margin-bottom: 8px;
            line-height: 1.3;
        }
        .kabupaten-popup-count {
            font-size: 24px;
            font-weight: 700;
            color: #045a96;
            margin: 4px 0;
        }
        .kabupaten-popup-label {
            font-size: 11px;
            color: #6b7280;
            margin-top: 2px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .swal2-popup.kabupaten-popup {
            max-width: 95vw !important;
            width: auto !important;
        }
        .kabupaten-popup-container {
            max-width: 100%;
            overflow-x: auto;
        }
        .kabupaten-popup-container::-webkit-scrollbar {
            height: 8px;
        }
        .kabupaten-popup-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        .kabupaten-popup-container::-webkit-scrollbar-thumb {
            background: #067ac1;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="admin-wrapper">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <img src="{{ url_for('static', filename='LOGO.png') }}" alt="BGTK Sulteng" class="sidebar-logo">
            </div>
            <nav class="sidebar-nav">
                <a href="{{ url_for('admin_dashboard') }}" class="sidebar-link active">
                    <span class="sidebar-icon icon-dashboard" aria-hidden="true">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M3 3h8v8H3V3zm10 0h8v5h-8V3zm0 7h8v11h-8V10zM3 13h8v8H3v-8z"/>
                        </svg>
                    </span>
                    <div class="sidebar-link-text">
                        <span class="sidebar-title">Dashboard</span>
                    </div>
                </a>
                <a href="{{ url_for('admin_kegiatan') }}" class="sidebar-link {% if 'kegiatan' in request.path and 'edit-kegiatan' not in request.path and 'detail' not in request.path %}active{% endif %}">
                    <span class="sidebar-icon icon-kegiatan" aria-hidden="true">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M9 3h6a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H9a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2Z"/>
                            <path d="M9 3V2h6v1m-5 5h4m-4 4h4m-4 4h4"/>
                        </svg>
                    </span>
                    <div class="sidebar-link-text">
                        <span class="sidebar-title">Kegiatan</span>
                    </div>
                </a>
                <a href="{{ url_for('admin_rekap_filter') }}" class="sidebar-link {% if 'rekap-filter' in request.path %}active{% endif %}">
                    <span class="sidebar-icon icon-rekap" aria-hidden="true">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 21s-6-4.35-6-10a6 6 0 1 1 12 0c0 5.65-6 10-6 10Z"/>
                            <circle cx="12" cy="11" r="2.2"/>
                        </svg>
                    </span>
                    <div class="sidebar-link-text">
                        <span class="sidebar-title">Rekap</span>
                    </div>
                </a>
                {% if user_role != 'operator' %}
                <a href="{{ url_for('admin_users') }}" class="sidebar-link {% if 'users' in request.path or 'edit-operator' in request.path %}active{% endif %}">
                    <span class="sidebar-icon icon-users" aria-hidden="true">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H7a4 4 0 0 0-4 4v2"/>
                            <circle cx="10" cy="8" r="4"/>
                            <path d="M21 21v-2a3 3 0 0 0-2-2.82m-3-11.65a3 3 0 0 1 0 5.94"/>
                        </svg>
                    </span>
                    <div class="sidebar-link-text">
                        <span class="sidebar-title">Operator</span>
                    </div>
                </a>
                {% endif %}
            </nav>
            <div class="sidebar-footer">
                <a href="{{ url_for('logout') }}" class="sidebar-link sidebar-link--logout">
                    <span class="sidebar-icon icon-logout" aria-hidden="true">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M15 17l5-5-5-5"/>
                            <path d="M20 12H9"/>
                            <path d="M13 21H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h6"/>
                        </svg>
                    </span>
                    <div class="sidebar-link-text">
                        <span class="sidebar-title">Logout</span>
                    </div>
                </a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="topbar">
                <div class="topbar-title">Selamat Datang, {{ user_display_name or 'Admin' }}!</div>
                <div class="profile-menu">
                    <button type="button" class="profile-btn" id="profileBtn">Profil</button>
                    <div class="profile-dropdown" id="profileDropdown">
                        <div class="profile-name">{{ user_display_name or 'Admin' }}</div>
                        <a href="{{ url_for('change_password') }}">Ubah Password</a>
                    </div>
                </div>
            </div>
            <div class="container">
                <!-- Flash Messages -->
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        <div class="flash-messages" style="display: none;">
                            {% for category, message in messages %}
                                <div class="flash-message flash-{{ category }}">{{ message }}</div>
                            {% endfor %}
                        </div>
                    {% endif %}
                {% endwith %}

                <!-- Statistics Grid -->
                <div class="stats-grid">
                    <a href="{{ url_for('admin_kegiatan') }}" class="stat-card-link">
                        <div class="stat-card" style="cursor: pointer;">
                            <div class="stat-card-header">
                                <div>
                                    <p class="stat-card-title">Total Kegiatan</p>
                                    <p class="stat-card-value">{{ stats.total_kegiatan }}</p>
                                </div>
                                <div class="stat-card-icon">
                                    <span class="sidebar-icon icon-kegiatan" aria-hidden="true">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M9 3h6a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H9a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2Z"/>
                                            <path d="M9 3V2h6v1m-5 5h4m-4 4h4m-4 4h4"/>
                                        </svg>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </a>
                    
                    <a href="{{ url_for('admin_rekap_filter') }}" class="stat-card-link">
                        <div class="stat-card" style="cursor: pointer;">
                            <div class="stat-card-header">
                                <div>
                                    <p class="stat-card-title">Total Biodata</p>
                                    <p class="stat-card-value">{{ stats.total_biodata }}</p>
                                </div>
                                <div class="stat-card-icon">
                                    <span class="sidebar-icon icon-users" aria-hidden="true">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M17 21v-2a4 4 0 0 0-4-4H7a4 4 0 0 0-4 4v2"/>
                                            <circle cx="10" cy="8" r="4"/>
                                            <path d="M21 21v-2a3 3 0 0 0-2-2.82m-3-11.65a3 3 0 0 1 0 5.94"/>
                                        </svg>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </a>

                    <a href="{{ url_for('admin_users') }}" class="stat-card-link">
                        <div class="stat-card" style="cursor: pointer;">
                            <div class="stat-card-header">
                                <div>
                                    <p class="stat-card-title">Total Operator</p>
                                    <p class="stat-card-value">{{ stats.total_users }}</p>
                                </div>
                                <div class="stat-card-icon">
                                    <span class="sidebar-icon icon-users" aria-hidden="true">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M17 21v-2a4 4 0 0 0-4-4H7a4 4 0 0 0-4 4v2"/>
                                            <circle cx="10" cy="8" r="4"/>
                                            <path d="M21 21v-2a3 3 0 0 0-2-2.82m-3-11.65a3 3 0 0 1 0 5.94"/>
                                        </svg>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </a>

                    <div class="stat-card" id="rekapKabupatenCard" style="cursor: pointer;">
                        <div class="stat-card-header">
                            <div>
                                <p class="stat-card-title">Rekap Per Kabupaten</p>
                                <p class="stat-card-value">{{ stats.total_kabupaten }}</p>
                            </div>
                            <div class="stat-card-icon">
                                <span class="sidebar-icon icon-rekap" aria-hidden="true">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M12 21s-6-4.35-6-10a6 6 0 1 1 12 0c0 5.65-6 10-6 10Z"/>
                                        <circle cx="12" cy="11" r="2.2"/>
                                    </svg>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chart: Jumlah Peserta per Kabupaten/Kota -->
                <div style="margin-top: 30px;">
                    <div class="kegiatan-card">
                        <h2 style="margin-top: 0; margin-bottom: 20px; font-size: 20px; font-weight: 600; color: #1f2937;">Grafik Rekap Peserta per Kabupaten/Kota</h2>
                        <div style="position: relative; width: 100%; max-width: 100%; height: 450px; overflow-x: auto;">
                            <canvas id="kabupatenChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script id="kabupatenData" type="application/json">{{ kabupaten_summary | default([]) | tojson | safe }}</script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script>
        // Profile dropdown toggle
        const profileBtn = document.getElementById('profileBtn');
        const profileDropdown = document.getElementById('profileDropdown');

        if (profileBtn && profileDropdown) {
            profileBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                profileDropdown.classList.toggle('show');
            });

            document.addEventListener('click', function(e) {
                if (!profileBtn.contains(e.target) && !profileDropdown.contains(e.target)) {
                    profileDropdown.classList.remove('show');
                }
            });
        }

        // Grafik batang jumlah peserta per kabupaten + popup detail
        document.addEventListener('DOMContentLoaded', function() {
            const rekapCard = document.getElementById('rekapKabupatenCard');
            const kabupatenDataElement = document.getElementById('kabupatenData');
            const kabupatenChartCanvas = document.getElementById('kabupatenChart');
            let kabupatenData = [];
            if (kabupatenDataElement && kabupatenDataElement.textContent) {
                try {
                    kabupatenData = JSON.parse(kabupatenDataElement.textContent);
                } catch (e) {
                    kabupatenData = [];
                }
            }

            // Inisialisasi grafik horizontal bar jika elemen canvas tersedia dan ada data
            if (kabupatenChartCanvas && kabupatenData && kabupatenData.length > 0 && window.Chart) {
                const labels = kabupatenData.map(item => item.nama);
                const values = kabupatenData.map(item => item.jumlah_peserta || 0);

                const ctx = kabupatenChartCanvas.getContext('2d');
                
                // Hitung nilai maksimum untuk menyesuaikan skala sumbu X
                const maxValue = Math.max(...values);
                const xAxisMax = maxValue > 0 ? Math.ceil(maxValue * 1.1) : undefined;
                
                // Warna untuk 13 kabupaten (dari biru ke pink/purple) - menggunakan warna solid yang bervariasi
                const barColors = [
                    'rgba(100, 181, 246, 0.85)',  // Light blue
                    'rgba(66, 165, 245, 0.85)',   // Blue
                    'rgba(92, 107, 192, 0.85)',   // Indigo
                    'rgba(121, 134, 203, 0.85)',  // Deep purple
                    'rgba(149, 117, 205, 0.85)',  // Purple
                    'rgba(186, 104, 200, 0.85)',  // Light purple
                    'rgba(233, 30, 99, 0.85)',    // Pink
                    'rgba(244, 67, 54, 0.85)',    // Red-pink
                    'rgba(236, 64, 122, 0.85)',   // Deep pink
                    'rgba(171, 71, 188, 0.85)',   // Purple-pink
                    'rgba(156, 39, 176, 0.85)',   // Dark purple
                    'rgba(103, 58, 183, 0.85)',   // Deep indigo
                    'rgba(63, 81, 181, 0.85)'     // Dark blue
                ];

                // Fungsi untuk membuat gradient per bar (setelah canvas siap)
                function createBarGradient(ctx, chartArea, colorIndex) {
                    const gradient = ctx.createLinearGradient(chartArea.left, 0, chartArea.right, 0);
                    const colors = barColors;
                    const startColor = colors[colorIndex % colors.length];
                    // Buat sedikit variasi untuk gradient effect
                    const endColor = startColor.replace('0.85', '0.95');
                    gradient.addColorStop(0, startColor);
                    gradient.addColorStop(1, endColor);
                    return gradient;
                }

                const backgroundColors = values.map((_, index) => barColors[index % barColors.length]);

                const chartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Jumlah Peserta',
                            data: values,
                            backgroundColor: backgroundColors,
                            borderColor: 'rgba(255, 255, 255, 0.2)',
                            borderWidth: 0,
                            borderRadius: {
                                topRight: 8,
                                bottomRight: 8,
                                topLeft: 0,
                                bottomLeft: 0
                            },
                            barThickness: 'flex',
                            maxBarThickness: 35,
                        }]
                    },
                    options: {
                        indexAxis: 'y', // Horizontal bar chart
                        responsive: true,
                        maintainAspectRatio: false,
                        layout: {
                            padding: {
                                left: 10,
                                right: 20,
                                top: 10,
                                bottom: 10
                            }
                        },
                        scales: {
                            x: {
                                beginAtZero: true,
                                max: xAxisMax, // Otomatis menyesuaikan maksimum berdasarkan nilai terbesar + padding 10%
                                ticks: {
                                    precision: 0,
                                    font: {
                                        size: 11,
                                        family: "'Segoe UI', Roboto, sans-serif"
                                    },
                                    color: '#374151',
                                    stepSize: function(context) {
                                        const max = context.scale.max;
                                        if (max <= 50) return 10;
                                        if (max <= 100) return 20;
                                        if (max <= 500) return 100;
                                        if (max <= 1000) return 200;
                                        if (max <= 5000) return 500;
                                        return 1000;
                                    },
                                    callback: function(value) {
                                        // Format angka dengan pemisah ribuan
                                        return value.toLocaleString('id-ID');
                                    }
                                },
                                grid: {
                                    display: true,
                                    color: 'rgba(0, 0, 0, 0.05)',
                                    lineWidth: 1,
                                    drawBorder: false
                                },
                                title: {
                                    display: false
                                }
                            },
                            y: {
                                ticks: {
                                    font: {
                                        size: 12,
                                        family: "'Segoe UI', Roboto, sans-serif"
                                    },
                                    color: '#374151',
                                    padding: 8
                                },
                                grid: {
                                    display: true,
                                    color: 'rgba(0, 0, 0, 0.05)',
                                    lineWidth: 1,
                                    drawBorder: false
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                padding: 12,
                                titleFont: {
                                    size: 13,
                                    weight: 'bold'
                                },
                                bodyFont: {
                                    size: 13
                                },
                                borderColor: 'rgba(6, 122, 193, 0.5)',
                                borderWidth: 1,
                                cornerRadius: 6,
                                displayColors: false,
                                callbacks: {
                                    title: function(context) {
                                        return context[0].label;
                                    },
                                    label: function(context) {
                                        return context.parsed.x.toLocaleString('id-ID') + ' peserta';
                                    }
                                }
                            },
                        }
                    }
                });

                // Menyesuaikan tinggi container berdasarkan jumlah kabupaten
                const chartContainer = kabupatenChartCanvas.closest('div[style*="height"]');
                if (chartContainer && labels.length > 0) {
                    // Setiap bar membutuhkan ~35px tinggi + padding lebih kecil
                    const calculatedHeight = Math.min(Math.max(350, labels.length * 35 + 80), 500);
                    chartContainer.style.height = calculatedHeight + 'px';
                }
            }

            const renderPopup = (data) => {
                if (!data || data.length === 0) return;

                let htmlContent = '<div class="kabupaten-popup-grid">';
                data.forEach(function(kabupaten) {
                    htmlContent += `
                        <div class="kabupaten-popup-item">
                            <div class="kabupaten-popup-name">${kabupaten.nama}</div>
                            <div class="kabupaten-popup-count">${kabupaten.jumlah_peserta}</div>
                            <div class="kabupaten-popup-label">peserta</div>
                        </div>
                    `;
                });
                htmlContent += '</div>';

                Swal.fire({
                    title: '<span style="font-size: 24px; color: #067ac1;">Rekap Per Kabupaten/Kota</span>',
                    html: htmlContent,
                    width: '95%',
                    maxWidth: '1200px',
                    confirmButtonText: 'Tutup',
                    confirmButtonColor: '#067ac1',
                    customClass: {
                        popup: 'kabupaten-popup',
                        htmlContainer: 'kabupaten-popup-container',
                        title: 'kabupaten-popup-title'
                    },
                    showCloseButton: true
                });
            };

            const fetchAndRender = () => {
                fetch('/api/kabupaten-summary')
                    .then(response => response.json())
                    .then(data => renderPopup(data))
                    .catch(error => {
                        console.error('Error fetching kabupaten summary:', error);
                        Swal.fire({
                            title: 'Error',
                            text: 'Gagal memuat data rekap kabupaten',
                            icon: 'error',
                            confirmButtonColor: '#067ac1'
                        });
                    });
            };

            if (rekapCard) {
                rekapCard.addEventListener('click', function() {
                    if (kabupatenData && kabupatenData.length > 0) {
                        renderPopup(kabupatenData);
                    } else {
                        fetchAndRender();
                    }
                });
            }
        });
    </script>
    <script src="{{ url_for('static', filename='js/sweetalert-flash.js') }}"></script>
</body>
</html>
